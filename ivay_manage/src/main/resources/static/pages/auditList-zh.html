<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <link rel="stylesheet" type="text/css" media="screen" href="../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="../layui/css/layui.css" media="all"/>
</head>
<body>
<div>
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div>
            <header style="height: 100%">
                <div align="left">
                    <table style="width: 100%">
                        <tr>
                            <td>
                                <form class="form-inline" onsubmit="return false">
                                    <div class="form-group">
                                        用户ID：
                                        <input id="userGid" type="text" class="form-control" placeholder="userGid">
                                        姓名：
                                        <input id="name" type="text" class="form-control" placeholder="name">
                                        手机号：
                                        <input id="phone" type="text" class="form-control" placeholder="phone">
                                        申请时间：
                                        <input id="fromTime" type="text" class="form-control" placeholder="fromTime"
                                               readonly="readonly">
                                        - <input id="toTime" type="text" class="form-control" placeholder="toTime"
                                                 readonly="readonly">
                                    </div>
                                    <div class="form-group" style="margin:2px">
                                        审核状态：
                                        <select id="auditStatus" class="form-control">
                                            <option value="2">待审核</option>
                                            <option value="3">审核通过</option>
                                            <option value="7">审核不通过</option>
                                        </select>
                                        <button id="searchBt" class="layui-btn layui-btn-sm">
                                            <i class="layui-icon">&#xe615;</i>搜索
                                        </button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                    </table>
                </div>
            </header>

            <div>
                <!-- 审核列表 -->
                <div class="widget-body no-padding">
                    <table id="dt-table" class="table table-striped table-bordered table-hover" style="width: 100%">
                        <thead>
                        <tr>
                            <th>行号</th>
                            <th>用户id</th>
                            <th>姓名</th>
                            <th>手机号</th>
                            <th>申请时间</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <!-- 审核详情 -->
                <div id="detail" class="widget-body no-padding" style="display: none">
                    <table id="dt-table2" class="table table-striped table-bordered table-hover" style="width: 100%">
                        <thead>
                        <tr>
                            <th>手机号</th>
                            <th>身份证号</th>
                            <th>姓名</th>
                            <th>出生日期</th>
                            <th>性别</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <th id="detail_phone">手机号</th>
                            <th id="detail_identityCard">身份证号</th>
                            <th id="detail_name">姓名</th>
                            <th id="detail_birthday">出生日期</th>
                            <th id="detail_sex">性别</th>
                        </tr>
                        </tbody>
                    </table>

                    <div>
                        <img id="photo1" src="" width="30%" height="300px" alt="photo1"/>
                        <img id="photo2" src="" width="30%" height="300px" alt="photo2"/>
                        <img id="photo3" src="" width="30%" height="300px" alt="photo3"/>
                    </div>
                    <form class="form-inline" onsubmit="return false" style="margin: 2px">
                        <div class="form-group">
                            姓名： <input id="detail_name2" type="text" class=" form-control" placeholder="name">
                            身份证： <input id="detail_identityCard2" type="text" class=" form-control"
                                        placeholder="identityCard">
                            生日： <input id="detail_birthday2" type="text" class=" form-control" placeholder="birthday"
                                       readonly="readonly">
                            性别
                            <input type="radio" name="sex" value="0"/>男
                            <input type="radio" name="sex" value="1"/>女
                        </div>
                    </form>
                    <div class="form-group" style="margin:2px">
                        <button onclick="auditSubmit(1)" class="layui-btn layui-btn-sm">
                            <i class="layui-icon">&#xe615;</i>审核通过
                        </button>
                        <button onclick="auditSubmit(0)" class="layui-btn layui-btn-sm">
                            <i class="layui-icon">&#xe615;</i>审核驳回
                        </button>
                        <!--<button onclick="auditSubmit(2)" class="layui-btn layui-btn-sm">-->
                        <!--<i class="layui-icon">&#xe615;</i>重新提交-->
                        <!--</button>-->
                        <label>驳回理由：</label>
                        <select id="refuseReason">
                            <option value="">请选择</option>
                            <option value="1001">1001:身份证正面或反面照片模糊或拍摄角度差</option>
                            <option value="1002">1002:未拍摄到身份证照片</option>
                            <option value="1003">1003:未拍摄身份证原件(如复印件、电子版)</option>
                            <option value="1004">1004:手持身份证照片或活体照片模糊</option>
                            <option value="1005">1005:没有上传活体照片/手持照片</option>
                            <option value="1006">1006:活体照片/手持照片拍摄不标准</option>
                            <option value="2001">2001:身份证过期</option>
                            <option value="2002">2002:填写身份证号/姓名/生日与证件上的号码不一致</option>
                            <option value="2003">2003:身份证疑似造假(PS,后贴照片等)</option>
                            <option value="2004">2004:疑似重复申请（活体照片或手持照片或身份证照片与其他申请用户为同一人）</option>
                            <option value="3001">3001:活体照片或手持照片与身份证头像不一致</option>
                            <option value="3002">3002:活体照片与手持照片不一致</option>
                            <option value="3003">3003:手持照片里的本人与手持证件头像不一致</option>
                            <option value="3004">3004:手持证件与拍摄证件不一致</option>
                            <option value="3005">3005:个人信息姓名与身份证姓名不一致</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script type="text/javascript" src="../js/libs/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../js/jq.js"></script>
<script type="text/javascript" src="../js/plugin/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="../layui/layui.js"></script>
<script type="text/javascript" src="../js/my/permission.js"></script>
<script type="text/javascript">
    var pers = checkPermission();
    var domain = window.location.protocol + "//" + window.location.host;
    var handle_id = "";

    // 初始化审核列表
    var example;

    function init() {
        example = $('#dt-table').DataTable({
            "searching": false,
            "processing": false,
            "serverSide": true,
            "language": {
                "url": "/js/plugin/datatables/Chinese.lang"
            },
            "ajax": {
                "url": "/audit/list",
                "type": "post",
                "data": function (d) {
                    d.userGid = $("#userGid").val();
                    d.name = $("#name").val();
                    d.phone = $("#phone").val();
                    d.fromTime = $("#fromTime").val();
                    d.toTime = $("#toTime").val();
                    d.auditStatus = $("#auditStatus").val();
                },
                "error": function (xhr, textStatus, errorThrown) {
                    var msg = xhr.responseText;
                    console.log(msg);
                    var response = JSON.parse(msg);
                    var code = response.code;
                    var message = response.message;
                    if (code == 400) {
                        layer.msg(message);
                    } else if (code == 401) {
                        localStorage.removeItem("token");
                        layer.msg("token过期，请先登录", {shift: -1, time: 1000}, function () {
                            location.href = '/login.html';
                        });
                    } else if (code == 403) {
                        console.log("未授权:" + message);
                        layer.msg('未授权');
                    } else if (code == 500) {
                        layer.msg('系统错误：' + message);
                    }
                }
            },
            "dom": "<'dt-toolbar'r>t<'dt-toolbar-footer'<'col-sm-10 col-xs-12 hidden-xs'i><'col-xs-12 col-sm-10' p v>>",
            "columns": [
                {"data": "num", "defaultContent": "", "visible": false},
                {"data": "userGid", "defaultContent": ""},
                {"data": "name", "defaultContent": ""},
                {"data": "phone", "defaultContent": ""},
                {"data": "createTime", "defaultContent": ""},
                {
                    "data": "",
                    "defaultContent": "",
                    "orderable": false,
                    "render": function (data, type, row) {
                        var gid = row['userGid'];
                        return "<button id='showDetail' class='btn btn-success' type='button' onclick='showDetail(" + '\"' + gid + '\"' + ")' >详情<i class='fa fa-edit'></i></button>&nbsp;";
                    }
                }
            ],
            "order": [[1, "asc"]]
        });
    }

    //加载时间插件
    layui.use(['layer', 'laydate'], function () {
        var layer = layui.layer;
        var laydate = layui.laydate;
        laydate.render({
            elem: '#birthday'
        });
        laydate.render({
            elem: '#fromTime'
        });
        laydate.render({
            elem: '#toTime'
        });
        laydate.render({
            elem: '#detail_birthday2'
        });

    });

    // 搜索审核列表
    $("#searchBt").click(function () {
        searchList()
    });

    // 搜索列表
    function searchList() {
        initDetail();
        example.settings()[0].ajax.data = {
            "userGid": $("#userGid").val(),
            "name": $("#name").val(),
            "phone": $("#phone").val(),
            "fromTime": $("#fromTime").val(),
            "toTime": $("#toTime").val(),
            "auditStatus": $("#auditStatus").val()
        };
        example.ajax.reload();
    }

    // 清空审核详情
    function initDetail() {
        $("#detail_name").text("姓名");
        $("#detail_identityCard").text("身份证");
        $("#detail_birthday").text("生日");
        $("#detail_phone").text("电话");
        $("#detail_sex").text("性别");
        $("#detail_name2").val("");
        $("#detail_identityCard2").val("");
        $("#detail_birthday2").val("");
        handle_id = "";
        $('#detail').css("display", "none");
    }

    //查看审核详情
    function showDetail(gid) {
        initDetail();
        $.ajax({
            url: "/audit/detail?userGid=" + gid,
            type: "get",
            success: function (data, textStatus) {
                if (data.status.code != "200") {
                    alert(data.status.message);
                } else {
                    handle_id = data.bo.userGid;
                    $("#detail").css("display", "block");
                    $("#detail_name").text(data.bo.name);
                    $("#detail_identityCard").text(data.bo.identityCard);
                    $("#detail_birthday").text(data.bo.birthday);
                    $("#detail_phone").text(data.bo.phone);
                    $("#detail_sex").text(data.bo.sex);
                    $("#photo1").attr("src", domain + "/statics" + data.bo.photo1Url);
                    $("#photo2").attr("src", domain + "/statics" + data.bo.photo2Url);
                    $("#photo3").attr("src", domain + "/statics" + data.bo.photo3Url);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("审核详情查询报错了。")
            }
        });
    }

    // 审核
    function auditSubmit(flag) {
        if (flag == 1) {
            if ($("#detail_name2").val() != $("#detail_name").text() ||
                $("#detail_identityCard2").val() != $("#detail_identityCard").text() ||
                $("input[name='sex']:checked").val() != $("#detail_sex").text() ||
                $("#detail_birthday2").val() == "" ||
                $("#detail_birthday").text().indexOf($("#detail_birthday2").val()) == -1
            ) {
                alert("请核实申请人信息")
                return;
            }
        } else if ($("#refuseReason").val() == "") {
            alert("请选择驳回理由");
            return;
        }

        $.ajax({
            url: "/audit/update?userGid=" + handle_id + "&flag=" + flag
                + "&refuseCode=" + $("#refuseReason").val() +
                "&refuseDemo=" + $("#refuseReason").find("option:selected").text(),
            type: "post",
            success: function (data, textStatus) {
                if (data.status.code != "200") {
                    alert(data.status.message);
                } else {
                    searchList()
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("审核报错了。")
            }
        });
    }

    init();
</script>
