<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ivay.ivay_repository.dao.master.XCollectionCalculateDao">

    <sql id="list_condition">
        <where>
            			<if test="params.id != null and params.id != ''">
				and id = #{params.id} 
			</if>
			<if test="params.calculate_date != null and params.calculate_date != ''">
				and calculate_date = #{params.calculateDate} 
			</if>
			<if test="params.overdue_order != null and params.overdue_order != ''">
				and overdue_order = #{params.overdueOrder} 
			</if>
			<if test="params.overdue_user != null and params.overdue_user != ''">
				and overdue_user = #{params.overdueUser} 
			</if>
			<if test="params.overdue_principal != null and params.overdue_principal != ''">
				and overdue_principal = #{params.overduePrincipal} 
			</if>
			<if test="params.amount_receivable != null and params.amount_receivable != ''">
				and amount_receivable = #{params.amountReceivable} 
			</if>
			<if test="params.number_repay != null and params.number_repay != ''">
				and number_repay = #{params.numberRepay} 
			</if>
			<if test="params.amount_repay != null and params.amount_repay != ''">
				and amount_repay = #{params.amountRepay} 
			</if>
			<if test="params.create_time != null and params.create_time != ''">
				and create_time = #{params.createTime} 
			</if>
			<if test="params.update_time != null and params.update_time != ''">
				and update_time = #{params.updateTime} 
			</if>

        </where>
    </sql>

    <select id="count" resultType="int">
        select count(1) from x_collection_calculatesys_user t
        <include refid="list_condition"/>
    </select>

    <select id="list" resultType="com.ivay.ivay_repository.model.XCollectionCalculate">
        select * from x_collection_calculatesys_user t
        <include refid="list_condition"/>
        <if test="params.orderBy!=null and params.orderBy!=''">
            ${params.orderBy}
        </if>
        <if test="limit != null and limit != 0">
            limit #{offset}, #{limit}
        </if>
    </select>

	<update id="update">
        update x_collection_calculatesys_user t
        <set>
            			<if test="calculate_date != null">
				calculate_date = #{calculateDate}, 
			</if>
			<if test="overdue_order != null">
				overdue_order = #{overdueOrder}, 
			</if>
			<if test="overdue_user != null">
				overdue_user = #{overdueUser}, 
			</if>
			<if test="overdue_principal != null">
				overdue_principal = #{overduePrincipal}, 
			</if>
			<if test="amount_receivable != null">
				amount_receivable = #{amountReceivable}, 
			</if>
			<if test="number_repay != null">
				number_repay = #{numberRepay}, 
			</if>
			<if test="amount_repay != null">
				amount_repay = #{amountRepay}, 
			</if>
			<if test="create_time != null">
				create_time = #{createTime}, 
			</if>
			<if test="update_time != null">
				update_time = #{updateTime}, 
			</if>

        </set>
        where t.id = #{id}
    </update>

	<!-- 获取催收报表的逾期订单统计 -->
	<select id="selectCollectionsCalculate" resultType="com.ivay.ivay_repository.model.XCollectionCalculate">
		SELECT
		t1.due_time,
		SUM( t1.due_amount ) AS due_amount,
		SUM( t1.amount ) AS amount,
		COUNT( order_id ) AS due_order_count,
		count( user_gid ) AS due_user_count
		FROM
		(
		SELECT
		DATE_FORMAT( due_time, '%Y%m%d' ) AS due_time,
		due_amount,
		( due_amount + overdue_interest ) AS amount,
		order_id,
		user_gid
		FROM
		x_record_loan
		WHERE
		loan_status = 1
		AND repayment_status != 2
		<!-- AND due_time &lt; DATE_FORMAT( SYSDATE( ), '%Y%m%d' )-->
		AND due_time &lt;= #{endDate} AND due_time &gt; #{beginDate}
		) t1
	</select>

	<!-- 获取催收报表的还款统计 -->
	<select id="selectRepaytionCalculate" resultType="com.ivay.ivay_repository.model.XCollectionCalculate">
		SELECT
		count( DISTINCT t5.user_gid ) AS number_repay,
		SUM( t5.repayment_amount ) AS amount_repay
		FROM
		(
		SELECT
		t3.order_id,
		t3.user_gid,
		t4.record_loan_gid,
		t4.repayment_amount,
		DATE_FORMAT( SYSDATE( ), '%Y%m%d' ) AS calculate_time
		FROM
		(
		SELECT
			t1.*,
			t2.gid
		FROM
			( SELECT order_id, any_value(user_gid) as user_gid, any_value(create_time) as create_time FROM x_collection_task WHERE collector_id IS NOT NULL
				AND create_time &lt;= #{endDate} AND create_time &gt; #{beginDate} group by order_id) t1
		LEFT JOIN x_record_loan t2 ON t1.order_id = t2.order_id) t3

		INNER JOIN ( SELECT record_loan_gid, repayment_amount, create_time FROM x_record_repayment WHERE create_time &lt;= #{endDate}
			AND create_time &gt; #{beginDate} AND repayment_status = 2 ) t4
		ON t3.gid = t4.record_loan_gid AND t3.create_time &lt; t4.create_time
		) t5
	</select>

	<!-- 查询催收统计列表 -->
    <select id="selectCalculateList" resultType="com.ivay.ivay_repository.model.XCollectionCalculate">
		SELECT
			*
		FROM
			x_collection_calculate
		<where>
			<if test="params.beginTime != null">
				and calculate_date &gt;= #{params.beginTime}
			</if>
			<if test="params.endTime != null">
				and calculate_date &lt;= #{params.endTime}
			</if>
		</where>
		ORDER BY
		calculate_date DESC

		<if test="limit != null and limit != 0">
			limit #{offset}, #{limit}
		</if>
	</select>

	<!-- 查询催收统计总数 -->
	<select id="selectTotalCalculate" resultType="com.ivay.ivay_repository.dto.CollectionCalculateResult">
		SELECT
		SUM( overdue_order ) AS total_overdue_order,
		SUM( overdue_user ) AS total_overdue_user,
		SUM( overdue_principal ) AS total_overdue_money,
		SUM( amount_receivable ) AS total_receivable,
		SUM( number_repay ) AS total_repay_user,
		SUM( amount_repay ) AS total_repay_money
		FROM
		x_collection_calculate
		<where>
			<if test="params.beginTime != null">
				and calculate_date &gt;= #{params.beginTime}
			</if>
			<if test="params.endTime != null">
				and calculate_date &lt;= #{params.endTime}
			</if>
		</where>
	</select>

	<!-- 查询催收统计列表记录总数 -->
	<select id="selectCalculateListCount" resultType="java.lang.Integer">
		SELECT
		count(1)
		FROM
		x_collection_calculate
		<where>
			<if test="params.beginTime != null">
				and calculate_date &gt;= #{params.beginTime}
			</if>
			<if test="params.endTime != null">
				and calculate_date &lt;= #{params.endTime}
			</if>
		</where>
	</select>

</mapper>
